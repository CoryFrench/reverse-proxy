events {
    worker_connections 1024;
}

http {
    # Define upstream servers for each application
    upstream chatgpt_daily {
        server chatgpt-daily-app:14000;
    }

    upstream agent_directory {
        server agent-directory-app:14100;
    }

    upstream calendar_backend {
        server calendar-backend-app:5000;
    }

    upstream calendar_frontend {
        server calendar-frontend-app:80;
    }

    # Main server block
    server {
        listen 80;
        server_name localhost;

        # Health check for the reverse proxy itself
        location /health {
            access_log off;
            return 200 "Reverse Proxy is healthy\n";
            add_header Content-Type text/plain;
        }

        # Route ChatGPT Daily GPT Server
        location /api/chatgpt-daily/ {
            proxy_pass http://chatgpt_daily/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            # Remove the /api/chatgpt-daily prefix when forwarding
            rewrite ^/api/chatgpt-daily/(.*)$ /$1 break;
        }

        # Route Agent Directory
        location /api/agent-directory/ {
            proxy_pass http://agent_directory/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            rewrite ^/api/agent-directory/(.*)$ /$1 break;
        }

        # Handle agent directory login redirects
        location /login {
            proxy_pass http://agent_directory/login;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Handle agent directory assets
        location /assets/ {
            proxy_pass http://agent_directory/assets/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Route Calendar Backend API
        location /api/calendar-backend/ {
            proxy_pass http://calendar_backend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            rewrite ^/api/calendar-backend/(.*)$ /$1 break;
        }

        # Route Calendar Frontend
        location /api/calendar-frontend/ {
            proxy_pass http://calendar_frontend/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            rewrite ^/api/calendar-frontend/(.*)$ /$1 break;
        }

        # Handle React app static assets that use absolute paths
        location /static/ {
            proxy_pass http://calendar_frontend/static/;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Handle manifest.json and other root assets for React app
        location ~ ^/(manifest\.json|favicon\.ico|logo.*\.png)$ {
            proxy_pass http://calendar_frontend/$1;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Default route - you can customize this
        location / {
            return 200 '
<!DOCTYPE html>
<html>
<head>
    <title>API Gateway</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 40px; }
        .endpoint { background: #f5f5f5; padding: 10px; margin: 10px 0; border-radius: 5px; }
        .available { color: #008000; }
        .pending { color: #808080; }
    </style>
</head>
<body>
    <h1>API Gateway</h1>
    <p>Available endpoints:</p>
    
    <div class="endpoint available">
        <strong>ChatGPT Daily GPT Server:</strong><br>
        <a href="/api/chatgpt-daily/health">/api/chatgpt-daily/health</a><br>
        <a href="/api/chatgpt-daily/videos">/api/chatgpt-daily/videos</a><br>
        <a href="/api/chatgpt-daily/tasks">/api/chatgpt-daily/tasks</a><br>
        <a href="/api/chatgpt-daily/headlines">/api/chatgpt-daily/headlines</a>
    </div>
    
    <div class="endpoint available">
        <strong>Agent Directory:</strong><br>
        <a href="/api/agent-directory/health">/api/agent-directory/health</a><br>
        <a href="/api/agent-directory/">/api/agent-directory/</a>
    </div>
    
    <div class="endpoint available">
        <strong>Calendar Backend API:</strong><br>
        <a href="/api/calendar-backend/health">/api/calendar-backend/health</a><br>
        <a href="/api/calendar-backend/">/api/calendar-backend/</a>
    </div>
    
    <div class="endpoint available">
        <strong>Calendar Frontend:</strong><br>
        <a href="/api/calendar-frontend/">/api/calendar-frontend/</a>
    </div>
    
    <div class="endpoint available">
        <strong>Gateway Health:</strong> <a href="/health">/health</a>
    </div>
</body>
</html>';
            add_header Content-Type text/html;
        }

        # Error pages
        error_page 502 503 504 /50x.html;
        location = /50x.html {
            return 502 "Service temporarily unavailable. Please check if the target application is running.";
            add_header Content-Type text/plain;
        }
    }
} 